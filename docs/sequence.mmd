sequenceDiagram
    autonumber

    participant CLI as run.py
    participant GEN as generator.py
    participant CTX as context_builder.py
    participant BUD as llm_budget.py
    participant ENG as scenario_engine.py
    participant PUB as publisher.py
    participant JIRA as Jira / Confluence
    participant LLM as LLM Corporativo

    CLI->>GEN: run_main(issue_key, target_project)

    GEN->>CTX: build_truth_sources()
    CTX->>JIRA: get_issue(), dependencies
    JIRA-->>CTX: issues

    GEN->>CTX: resolve_anchor_epic()
    CTX->>JIRA: epic / parent epic

    GEN->>CTX: build_additional_context()
    CTX->>JIRA: referenced issues
    CTX->>JIRA: confluence docs

    GEN->>CTX: build_epic_context()
    CTX->>JIRA: epic documentation

    GEN->>BUD: build_llm_payload()
    BUD-->>GEN: payload recortado

    GEN->>ENG: generate_scenarios_with_full_coverage()
    ENG->>LLM: call_github_models()
    LLM-->>ENG: inventario + escenarios

    ENG->>LLM: completion missing (si aplica)
    LLM-->>ENG: escenarios faltantes

    ENG-->>GEN: escenarios validados

    GEN->>PUB: publish_test_cases()
    PUB->>JIRA: create_test_case()
    PUB->>JIRA: link_issues()

    PUB-->>GEN: resumen
    GEN-->>CLI: exit code
